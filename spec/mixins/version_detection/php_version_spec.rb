require 'spec_helper'
require 'ronin/exploits/mixins/version_detection/php_version'

require 'ronin/exploits/exploit'

describe Ronin::Exploits::Mixins::VersionDetection::PHPVersion do
  module TestPHPVersionMixin
    class TestExploit < Ronin::Exploits::Exploit

      include Ronin::Exploits::Mixins::VersionDetection::PHPVersion

    end
  end

  let(:test_class) { TestPHPVersionMixin::TestExploit }

  describe ".included" do
    subject { test_class }

    it "must also include Ronin::Exploits::Mixins::VersionDetection" do
      expect(subject).to include(Ronin::Exploits::Mixins::VersionDetection)
    end

    it "must also include Ronin::Exploits::Mixins::HTTP" do
      expect(subject).to include(Ronin::Exploits::Mixins::HTTP)
    end
  end

  let(:base_url) { 'http://example.com/' }

  subject do
    test_class.new(params: {base_url: base_url})
  end

  describe "#php_version" do
    context "when the HTTP response contains the 'X-Powered-By' header" do
      context "and it starts with 'PHP/'" do
        context "and it contains a version string" do
          let(:version) { '1.2.3' }
          let(:header)  { "PHP/#{version}" }

          before do
            expect(subject).to receive(:http_powered_by_header).with('/').and_return(header)
          end

          it "must return the version string" do
            expect(subject.php_version).to eq(version)
          end
        end

        context "but it does not contain a version string" do
          let(:header)  { "PHP/foo" }

          before do
            expect(subject).to receive(:http_powered_by_header).with('/').and_return(header)
          end

          it "must return nil" do
            expect(subject.php_version).to be(nil)
          end
        end
      end

      context "but it does not start with 'PHP/'" do
        let(:header)  { "Nginx" }

        before do
          expect(subject).to receive(:http_powered_by_header).with('/').and_return(header)
        end

        it "must return nil" do
          expect(subject.php_version).to be(nil)
        end
      end
    end

    context "but the HTTP response does not contain the 'X-Powered-By' header" do
      before do
        expect(subject).to receive(:http_powered_by_header).with('/').and_return(nil)
      end

      it "must return nil" do
        expect(subject.php_version).to be(nil)
      end
    end

    context "when given a custom path argument" do
      let(:version) { '1.2.3' }
      let(:header)  { "PHP/#{version}" }

      let(:path) { '/other' }

      it "must request the HTTP 'X-Powered-By' header for that path" do
        expect(subject).to receive(:http_powered_by_header).with(path).and_return(header)

        expect(subject.php_version(path)).to eq(version)
      end
    end

    context "when given custom keyword arguments" do
      let(:version) { '1.2.3' }
      let(:header)  { "PHP/#{version}" }

      let(:cookie) { 'sessionid=1234abcd' }

      it "must pass those keyword arguments to #http_powered_by_header" do
        expect(subject).to receive(:http_powered_by_header).with('/', cookie: cookie).and_return(header)

        expect(subject.php_version(cookie: cookie)).to eq(version)
      end
    end
  end

  describe "#detect_version" do
    context "when the HTTP response contains the 'X-Powered-By' header" do
      context "and it starts with 'PHP/'" do
        context "and it contains a version string" do
          let(:version) { '1.2.3' }
          let(:header)  { "PHP/#{version}" }

          before do
            expect(subject).to receive(:http_powered_by_header).with('/').and_return(header)
          end

          it "must return the version string" do
            expect(subject.detect_version).to eq(version)
          end
        end

        context "but it does not contain a version string" do
          let(:header)  { "PHP/foo" }

          before do
            expect(subject).to receive(:http_powered_by_header).with('/').and_return(header)
          end

          it "must return nil" do
            expect(subject.detect_version).to be(nil)
          end
        end
      end

      context "but it does not start with 'PHP/'" do
        let(:header)  { "Nginx" }

        before do
          expect(subject).to receive(:http_powered_by_header).with('/').and_return(header)
        end

        it "must return nil" do
          expect(subject.detect_version).to be(nil)
        end
      end
    end

    context "but the HTTP response does not contain the 'X-Powered-By' header" do
      before do
        expect(subject).to receive(:http_powered_by_header).with('/').and_return(nil)
      end

      it "must return nil" do
        expect(subject.detect_version).to be(nil)
      end
    end
  end
end
